// ===== SOLUCI√ìN COMPLETA PARA MEN√ö HAMBURGUESA =====

console.log('üîß Iniciando correcci√≥n del men√∫ hamburguesa...');

// Variables globales
let isMenuOpen = false;
let menuButton = null;
let mobileMenu = null;
let navLinks = [];

// ===== FUNCI√ìN 1: INICIALIZAR ELEMENTOS =====
function initializeMenuElements() {
    menuButton = document.getElementById('mobile-menu');
    mobileMenu = document.getElementById('nav-menu');
    navLinks = document.querySelectorAll('.nav-link');
    
    console.log('üìã Elementos encontrados:', {
        menuButton: !!menuButton,
        mobileMenu: !!mobileMenu,
        navLinks: navLinks.length
    });
    
    if (!menuButton || !mobileMenu) {
        console.error('‚ùå No se encontraron elementos esenciales del men√∫');
        return false;
    }
    
    return true;
}

// ===== FUNCI√ìN 2: ABRIR MEN√ö =====
function openMenu() {
    console.log('üìÇ Abriendo men√∫...');
    
    isMenuOpen = true;
    
    // Activar clases
    menuButton.classList.add('active');
    mobileMenu.classList.add('active');
    
    // Prevenir scroll del body
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${window.pageYOffset}px`;
    document.body.style.width = '100%';
    
    // Asegurar visibilidad
    mobileMenu.style.opacity = '1';
    mobileMenu.style.visibility = 'visible';
    mobileMenu.style.transform = 'translateY(0)';
    
    console.log('‚úÖ Men√∫ abierto');
}

// ===== FUNCI√ìN 3: CERRAR MEN√ö =====
function closeMenu() {
    console.log('üìÅ Cerrando men√∫...');
    
    isMenuOpen = false;
    
    // Remover clases
    menuButton.classList.remove('active');
    mobileMenu.classList.remove('active');
    
    // Restaurar scroll del body
    const scrollY = document.body.style.top;
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    
    if (scrollY) {
        window.scrollTo(0, parseInt(scrollY || '0') * -1);
    }
    
    // Ocultar men√∫
    mobileMenu.style.opacity = '0';
    mobileMenu.style.visibility = 'hidden';
    mobileMenu.style.transform = 'translateY(-20px)';
    
    console.log('‚úÖ Men√∫ cerrado');
}

// ===== FUNCI√ìN 4: TOGGLE MEN√ö =====
function toggleMenu() {
    console.log('üîÑ Toggle men√∫, estado actual:', isMenuOpen ? 'abierto' : 'cerrado');
    
    if (isMenuOpen) {
        closeMenu();
    } else {
        openMenu();
    }
}

// ===== FUNCI√ìN 5: DETECTAR M√ìVIL =====
function isMobile() {
    return window.innerWidth <= 768;
}

// ===== FUNCI√ìN 6: CONFIGURAR EVENT LISTENERS =====
function setupEventListeners() {
    
    // 1. Click en bot√≥n hamburguesa
    if (menuButton) {
        // Remover listeners previos
        const newMenuButton = menuButton.cloneNode(true);
        menuButton.parentNode.replaceChild(newMenuButton, menuButton);
        menuButton = newMenuButton;
        
        menuButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üñ±Ô∏è Click en bot√≥n hamburguesa');
            toggleMenu();
        });
        
        menuButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üëÜ Touch en bot√≥n hamburguesa');
            toggleMenu();
        });
    }
    
    // 2. Click en enlaces del men√∫
    navLinks.forEach((link, index) => {
        const newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);
        navLinks[index] = newLink;
        
        newLink.addEventListener('click', function(e) {
            console.log('üîó Click en enlace del men√∫');
            if (isMobile() && isMenuOpen) {
                setTimeout(() => {
                    closeMenu();
                }, 100);
            }
        });
    });
    
    // 3. Click fuera del men√∫
    document.addEventListener('click', function(e) {
        if (isMenuOpen && 
            !menuButton.contains(e.target) && 
            !mobileMenu.contains(e.target)) {
            console.log('üñ±Ô∏è Click fuera del men√∫');
            closeMenu();
        }
    });
    
    // 4. Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isMenuOpen) {
            console.log('‚å®Ô∏è Escape presionado');
            closeMenu();
        }
    });
    
    // 5. Resize window
    window.addEventListener('resize', function() {
        if (!isMobile() && isMenuOpen) {
            console.log('üì±‚û°Ô∏èüíª Cambio a desktop, cerrando men√∫');
            closeMenu();
        }
    });
    
    console.log('‚úÖ Event listeners configurados');
}

// ===== FUNCI√ìN 7: APLICAR ESTILOS CSS CR√çTICOS =====
function applyCriticalStyles() {
    
    // Crear elemento de estilo
    const style = document.createElement('style');
    style.id = 'hamburger-menu-fix';
    
    style.innerHTML = `
        /* ===== ESTILOS CR√çTICOS PARA MEN√ö HAMBURGUESA ===== */
        
        @media screen and (max-width: 768px) {
            
            /* Bot√≥n hamburguesa base */
            .nav-toggle {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                cursor: pointer !important;
                padding: 8px !important;
                background-color: #000 !important;
                border: 2px solid rgba(255, 255, 255, 0.3) !important;
                border-radius: 10px !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                z-index: 1001 !important;
                min-height: 40px !important;
                min-width: 40px !important;
                touch-action: manipulation !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            .nav-toggle:hover {
                background-color: rgba(0, 0, 0, 0.8) !important;
                border-color: rgba(255, 255, 255, 0.5) !important;
            }
            
            .nav-toggle:active {
                transform: scale(0.95) !important;
            }
            
            /* Barras del hamburguesa */
            .bar {
                width: 22px !important;
                height: 2px !important;
                background-color: #fff !important;
                margin: 3px 0 !important;
                transition: all 0.4s ease !important;
                border-radius: 2px !important;
                display: block !important;
                transform-origin: center !important;
            }
            
            /* Estado activo del bot√≥n */
            .nav-toggle.active .bar:nth-child(1) {
                transform: translateY(5px) rotate(45deg) !important;
            }
            
            .nav-toggle.active .bar:nth-child(2) {
                opacity: 0 !important;
                transform: translateX(15px) !important;
            }
            
            .nav-toggle.active .bar:nth-child(3) {
                transform: translateY(-5px) rotate(-45deg) !important;
            }
            
            /* Men√∫ m√≥vil base */
            .nav-menu {
                position: fixed !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: 50vh !important;
                background: rgba(0, 0, 0, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                flex-direction: column !important;
                text-align: center !important;
                padding: 120px 0 20px 0 !important;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3) !important;
                border-bottom-left-radius: 40px !important;
                border-bottom-right-radius: 40px !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                z-index: 1000 !important;
                
                /* Estado oculto por defecto */
                opacity: 0 !important;
                visibility: hidden !important;
                transform: translateY(-100%) !important;
                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
                
                /* Flex para centrar contenido */
                display: flex !important;
                justify-content: flex-start !important;
                align-items: center !important;
                overflow-y: auto !important;
            }
            
            /* Estado activo del men√∫ */
            .nav-menu.active {
                opacity: 1 !important;
                visibility: visible !important;
                transform: translateY(0) !important;
            }
            
            /* Items del men√∫ */
            .nav-menu li {
                margin: 10px 0 !important;
                position: relative !important;
                padding-bottom: 10px !important;
                width: 100% !important;
                list-style: none !important;
            }
            
            .nav-menu li::after {
                content: '' !important;
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 1px !important;
                background: rgba(255, 255, 255, 0.2) !important;
            }
            
            .nav-menu li:last-child::after {
                display: none !important;
            }
            
            /* Enlaces del men√∫ */
            .nav-link {
                font-size: 18px !important;
                color: #fff !important;
                padding: 10px 20px !important;
                display: block !important;
                width: 100% !important;
                border-radius: 8px !important;
                transition: all 0.3s ease !important;
                text-decoration: none !important;
                font-weight: 500 !important;
            }
            
            .nav-link:hover {
                background-color: rgba(224, 253, 44, 0.1) !important;
                color: #E0FD2C !important;
            }
            
            /* Prevenir scroll cuando men√∫ abierto */
            body:has(.nav-menu.active) {
                overflow: hidden !important;
            }
            
            /* Navegaci√≥n container ajustes */
            .nav-container {
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 0 20px !important;
            }
            
            .nav-logo {
                order: 1 !important;
                flex: 1 !important;
                text-align: center !important;
            }
            
            .nav-toggle {
                order: 2 !important;
                margin-left: auto !important;
                flex-shrink: 0 !important;
            }
            
            /* Ocultar b√∫squeda en m√≥viles */
            .search-container {
                display: none !important;
            }
        }
        
        /* Desktop - ocultar bot√≥n hamburguesa */
        @media screen and (min-width: 769px) {
            .nav-toggle {
                display: none !important;
            }
            
            .nav-menu {
                position: static !important;
                width: auto !important;
                height: auto !important;
                background: transparent !important;
                backdrop-filter: none !important;
                flex-direction: row !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                border: none !important;
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                transition: none !important;
            }
            
            .nav-menu li {
                margin: 0 !important;
                padding: 0 !important;
                width: auto !important;
            }
            
            .nav-menu li::after {
                display: none !important;
            }
            
            .nav-link {
                font-size: 18px !important;
                padding: 0 !important;
                margin: 0 15px !important;
                width: auto !important;
                border-radius: 0 !important;
            }
        }
    `;
    
    // Remover estilo previo si existe
    const existingStyle = document.getElementById('hamburger-menu-fix');
    if (existingStyle) {
        existingStyle.remove();
    }
    
    // Agregar nuevo estilo
    document.head.appendChild(style);
    
    console.log('üé® Estilos cr√≠ticos aplicados');
}

// ===== FUNCI√ìN 8: INICIALIZACI√ìN PRINCIPAL =====
function initHamburgerMenu() {
    console.log('üöÄ Iniciando correcci√≥n del men√∫ hamburguesa...');
    
    // 1. Aplicar estilos cr√≠ticos
    applyCriticalStyles();
    
    // 2. Esperar un poco para que el DOM se estabilice
    setTimeout(() => {
        
        // 3. Inicializar elementos
        if (!initializeMenuElements()) {
            console.error('‚ùå No se pudieron inicializar los elementos del men√∫');
            return;
        }
        
        // 4. Asegurar estado inicial cerrado
        closeMenu();
        
        // 5. Configurar event listeners
        setupEventListeners();
        
        console.log('‚úÖ Men√∫ hamburguesa configurado correctamente');
        
    }, 200);
}

// ===== FUNCI√ìN 9: AUTO-INICIALIZACI√ìN =====
function autoInit() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHamburgerMenu);
    } else {
        initHamburgerMenu();
    }
}

// ===== FUNCI√ìN 10: DEBUGGING =====
function debugMenu() {
    console.log('üîç Debug del men√∫:', {
        isMenuOpen,
        menuButton: !!menuButton,
        mobileMenu: !!mobileMenu,
        navLinksCount: navLinks.length,
        isMobileView: isMobile(),
        menuHasActiveClass: mobileMenu?.classList.contains('active'),
        buttonHasActiveClass: menuButton?.classList.contains('active')
    });
}

// ===== INICIALIZACI√ìN AUTOM√ÅTICA =====
autoInit();

// ===== EXPORTAR PARA DEBUGGING =====
window.hamburgerMenu = {
    toggle: toggleMenu,
    open: openMenu,
    close: closeMenu,
    debug: debugMenu,
    isOpen: () => isMenuOpen,
    reinit: initHamburgerMenu
};

console.log('üì± Correcci√≥n del men√∫ hamburguesa cargada');
console.log('üí° Usa hamburgerMenu.debug() para debuggear');
console.log('üí° Usa hamburgerMenu.reinit() para reinicializar');
